<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Explorer - Country Information</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        #map { height: 500px; }
        .country-card:hover { transform: translateY(-5px); }
        .dark .bg-white { background-color: #1a202c !important; }
        .dark .text-gray-800 { color: #e2e8f0 !important; }
        .dark .border-gray-200 { border-color: #4a5568 !important; }
        .dark body { background-color: #1a202c; color: #e2e8f0; }
        .dark .bg-blue-50 { background-color: #2d3748 !important; }
        .dark .text-gray-500 { color: #a0aec0 !important; }
        .dark .text-gray-900 { color: #e2e8f0 !important; }
        .dark .bg-gray-200 { background-color: #4a5568 !important; color: #e2e8f0 !important; }
        [hidden] { display: none !important; }
        /* Bengali font */
        @import url('https://fonts.googleapis.com/css2?family=Hind+Siliguri&display=swap');
        .bn { font-family: 'Hind Siliguri', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <!-- Header with Toggles -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-blue-600">World Explorer</h1>
            <div class="flex space-x-4">
                <button id="languageToggle" class="px-3 py-1 bg-gray-200 rounded-md">বাংলা</button>
                <button id="darkModeToggle" class="px-3 py-1 bg-gray-200 rounded-md">Dark</button>
                <button id="aiButton" class="px-3 py-1 bg-blue-100 rounded-md flex items-center">
                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    AI
                </button>
            </div>
        </header>

        <!-- Search Bar with Autocomplete -->
        <div class="relative mb-8">
            <input id="searchInput" type="text" placeholder="Search for a country..." 
                   class="w-full p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
            <div id="autocompleteResults" class="absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg hidden dark:bg-gray-800 dark:border-gray-600"></div>
        </div>

        <!-- Main Content -->
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Left Sidebar - Continent/Country Selection -->
            <div class="lg:w-1/4">
                <div class="bg-white p-6 rounded-lg shadow-md mb-6 dark:bg-gray-800">
                    <h2 class="text-xl font-bold mb-4 dark:text-white" data-i18n="selectContinent">Select Continent</h2>
                    <div id="continentButtons" class="grid grid-cols-2 gap-2">
                        <!-- Continents will be added here by JavaScript -->
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md dark:bg-gray-800">
                    <h2 class="text-xl font-bold mb-4 dark:text-white" data-i18n="countries">Countries</h2>
                    <div id="countryList" class="space-y-2 max-h-96 overflow-y-auto">
                        <!-- Countries will be added here by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="lg:w-3/4">
                <!-- Map Container -->
                <div class="bg-white p-6 rounded-lg shadow-md mb-6 dark:bg-gray-800">
                    <h2 class="text-xl font-bold mb-4 dark:text-white" data-i18n="worldMap">World Map</h2>
                    <div id="map" class="rounded-lg"></div>
                </div>

                <!-- Country Information -->
                <div id="countryInfo" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden dark:bg-gray-800">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="countryName" class="text-2xl font-bold dark:text-white"></h2>
                        <button id="speakButton" class="p-2 bg-blue-100 rounded-full dark:bg-gray-700">
                            <svg id="speakIcon" class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Basic Info -->
                        <div>
                            <h3 class="text-lg font-semibold mb-2 dark:text-white" data-i18n="basicInfo">Basic Information</h3>
                            <div class="space-y-2 dark:text-gray-300">
                                <p><span class="font-semibold" data-i18n="area">Area:</span> <span id="countryArea">-</span> km²</p>
                                <p><span class="font-semibold" data-i18n="population">Population:</span> <span id="countryPopulation">-</span></p>
                                <p><span class="font-semibold" data-i18n="capital">Capital:</span> <span id="countryCapital">-</span></p>
                                <p><span class="font-semibold" data-i18n="currency">Currency:</span> <span id="countryCurrency">-</span></p>
                                <p><span class="font-semibold" data-i18n="languages">Languages:</span> <span id="countryLanguages">-</span></p>
                                <p><span class="font-semibold" data-i18n="timezone">Timezone:</span> <span id="countryTimezone">-</span></p>
                                <p><span class="font-semibold" data-i18n="touristVisa">Tourist Visa:</span> <span id="countryVisa">-</span></p>
                                <p><span class="font-semibold" data-i18n="gdp">GDP (nominal):</span> <span id="countryGDP">-</span></p>
                                <p><span class="font-semibold" data-i18n="armyRank">Military Strength Rank:</span> <span id="countryArmyRank">-</span></p>
                            </div>
                        </div>

                        <!-- Flag and Weather -->
                        <div>
                            <div class="mb-4">
                                <h3 class="text-lg font-semibold mb-2 dark:text-white" data-i18n="flag">Flag</h3>
                                <img id="countryFlag" src="" alt="Country Flag" class="h-24 border dark:border-gray-600">
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold mb-2 dark:text-white" data-i18n="weather">Weather</h3>
                                <div id="countryWeather" class="flex items-center space-x-4 dark:text-gray-300">
                                    <div id="weatherIcon" class="text-4xl">☀️</div>
                                    <div>
                                        <p><span class="font-semibold" data-i18n="condition">Condition:</span> <span id="weatherCondition">-</span></p>
                                        <p><span class="font-semibold" data-i18n="temperature">Temperature:</span> <span id="weatherTemp">-</span>°C</p>
                                        <p><span class="font-semibold" data-i18n="humidity">Humidity:</span> <span id="weatherHumidity">-</span>%</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tourist Attractions -->
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-2 dark:text-white" data-i18n="mostVisited">Most Visited Places</h3>
                        <div id="touristPlaces" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Comparison Tool -->
                <div id="comparisonTool" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden dark:bg-gray-800">
                    <h2 class="text-xl font-bold mb-4 dark:text-white" data-i18n="countryComparison">Country Comparison</h2>
                    <div class="flex flex-wrap gap-4 mb-4">
                        <select id="compareCountry1" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                        <select id="compareCountry2" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                        <button id="compareButton" class="px-4 py-2 bg-blue-600 text-white rounded-md" data-i18n="compare">Compare</button>
                    </div>
                    <div id="comparisonResults" class="hidden">
                        <!-- Comparison results will be shown here -->
                    </div>
                </div>

                <!-- Currency Converter -->
                <div id="currencyConverter" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden dark:bg-gray-800">
                    <h2 class="text-xl font-bold mb-4 dark:text-white" data-i18n="currencyConverter">Currency Converter</h2>
                    <div class="flex flex-wrap items-center gap-4">
                        <input type="number" id="convertAmount" class="p-2 border rounded-md w-24 dark:bg-gray-700 dark:border-gray-600 dark:text-white" value="1">
                        <select id="convertFrom" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                        <span data-i18n="to" class="dark:text-white">to</span>
                        <select id="convertTo" class="p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                        <button id="convertButton" class="px-4 py-2 bg-blue-600 text-white rounded-md" data-i18n="convert">Convert</button>
                    </div>
                    <div id="conversionResult" class="mt-4 text-xl font-semibold hidden dark:text-white"></div>
                </div>

                <!-- Save/Export Button -->
                <div class="flex justify-end">
                    <button id="exportButton" class="px-4 py-2 bg-green-600 text-white rounded-md flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                        </svg>
                        <span data-i18n="exportPDF">Export as PDF</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Modal -->
    <div id="aiModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md dark:bg-gray-800">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold dark:text-white" data-i18n="aiAssistant">AI Assistant</h3>
                <button id="closeAiModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-gray-100">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="aiResponse" class="mb-4 max-h-64 overflow-y-auto dark:text-gray-300">
                <p data-i18n="aiWelcome">How can I help you with information about countries?</p>
            </div>
            <div class="flex">
                <input id="aiQuery" type="text" class="flex-grow p-2 border rounded-l-md dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Ask about any country...">
                <button id="aiSubmit" class="px-4 py-2 bg-blue-600 text-white rounded-r-md" data-i18n="ask">Ask</button>
            </div>
        </div>
    </div>

    <script>
        // Main Application
        document.addEventListener('DOMContentLoaded', function() {
            // State management
            const state = {
                currentCountry: null,
                countries: [],
                continents: {},
                darkMode: false,
                language: 'en',
                savedCountries: [],
                isSpeaking: false,
                exchangeRates: {}
            };

            // Translation dictionary
            const translations = {
                'en': {
                    'selectContinent': 'Select Continent',
                    'countries': 'Countries',
                    'worldMap': 'World Map',
                    'basicInfo': 'Basic Information',
                    'area': 'Area',
                    'population': 'Population',
                    'capital': 'Capital',
                    'currency': 'Currency',
                    'languages': 'Languages',
                    'timezone': 'Timezone',
                    'touristVisa': 'Tourist Visa',
                    'gdp': 'GDP (nominal)',
                    'armyRank': 'Military Strength Rank',
                    'flag': 'Flag',
                    'weather': 'Weather',
                    'condition': 'Condition',
                    'temperature': 'Temperature',
                    'humidity': 'Humidity',
                    'mostVisited': 'Most Visited Places',
                    'countryComparison': 'Country Comparison',
                    'compare': 'Compare',
                    'currencyConverter': 'Currency Converter',
                    'to': 'to',
                    'convert': 'Convert',
                    'exportPDF': 'Export as PDF',
                    'aiAssistant': 'AI Assistant',
                    'aiWelcome': 'How can I help you with information about countries?',
                    'ask': 'Ask'
                },
                'bn': {
                    'selectContinent': 'মহাদেশ নির্বাচন করুন',
                    'countries': 'দেশসমূহ',
                    'worldMap': 'বিশ্ব মানচিত্র',
                    'basicInfo': 'মৌলিক তথ্য',
                    'area': 'আয়তন',
                    'population': 'জনসংখ্যা',
                    'capital': 'রাজধানী',
                    'currency': 'মুদ্রা',
                    'languages': 'ভাষা',
                    'timezone': 'সময় অঞ্চল',
                    'touristVisa': 'পর্যটন ভিসা',
                    'gdp': 'জিডিপি (নামমাত্র)',
                    'armyRank': 'সামরিক শক্তি র‍্যাঙ্ক',
                    'flag': 'পতাকা',
                    'weather': 'আবহাওয়া',
                    'condition': 'অবস্থা',
                    'temperature': 'তাপমাত্রা',
                    'humidity': 'আর্দ্রতা',
                    'mostVisited': 'সবচেয়ে জনপ্রিয় স্থান',
                    'countryComparison': 'দেশের তুলনা',
                    'compare': 'তুলনা করুন',
                    'currencyConverter': 'মুদ্রা পরিবর্তক',
                    'to': 'থেকে',
                    'convert': 'পরিবর্তন করুন',
                    'exportPDF': 'PDF হিসেবে ডাউনলোড করুন',
                    'aiAssistant': 'এআই সহকারী',
                    'aiWelcome': 'দেশ সম্পর্কে তথ্য জানতে আমি আপনাকে কিভাবে সাহায্য করতে পারি?',
                    'ask': 'জিজ্ঞাসা করুন'
                }
            };

            // DOM Elements
            const elements = {
                continentButtons: document.getElementById('continentButtons'),
                countryList: document.getElementById('countryList'),
                map: document.getElementById('map'),
                countryInfo: document.getElementById('countryInfo'),
                searchInput: document.getElementById('searchInput'),
                autocompleteResults: document.getElementById('autocompleteResults'),
                darkModeToggle: document.getElementById('darkModeToggle'),
                languageToggle: document.getElementById('languageToggle'),
                speakButton: document.getElementById('speakButton'),
                speakIcon: document.getElementById('speakIcon'),
                exportButton: document.getElementById('exportButton'),
                aiButton: document.getElementById('aiButton'),
                comparisonTool: document.getElementById('comparisonTool'),
                currencyConverter: document.getElementById('currencyConverter'),
                aiModal: document.getElementById('aiModal'),
                closeAiModal: document.getElementById('closeAiModal'),
                aiResponse: document.getElementById('aiResponse'),
                aiQuery: document.getElementById('aiQuery'),
                aiSubmit: document.getElementById('aiSubmit')
            };

            // Initialize the map
            const map = L.map('map').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Apply translations
            function applyTranslations(lang) {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    if (translations[lang] && translations[lang][key]) {
                        el.textContent = translations[lang][key];
                    }
                });
                
                // Update placeholders
                if (lang === 'bn') {
                    document.getElementById('searchInput').placeholder = 'একটি দেশ খুঁজুন...';
                    document.getElementById('aiQuery').placeholder = 'কোন দেশ সম্পর্কে জানতে চান...';
                } else {
                    document.getElementById('searchInput').placeholder = 'Search for a country...';
                    document.getElementById('aiQuery').placeholder = 'Ask about any country...';
                }
            }

            // Fetch all countries data
            fetch('https://restcountries.com/v3.1/all')
                .then(response => response.json())
                .then(data => {
                    state.countries = data;
                    organizeByContinent();
                    renderContinents();
                    populateSearchAutocomplete();
                    populateComparisonSelects();
                    populateCurrencySelects();
                    fetchExchangeRates();
                    
                    // Enhance country data with GDP and military rank (mock data)
                    enhanceCountryData();
                });

            // Enhance country data with GDP and military rank (mock data)
            function enhanceCountryData() {
                // Mock GDP data (in billion USD)
                const gdpData = {
                    'USA': 25439,
                    'China': 17963,
                    'Japan': 4232,
                    'Germany': 4082,
                    'India': 3385,
                    'UK': 3089,
                    'France': 2937,
                    'Brazil': 1920,
                    'Italy': 1861,
                    'Canada': 1836,
                    'Russia': 1835,
                    'South Korea': 1665,
                    'Australia': 1543,
                    'Spain': 1406,
                    'Mexico': 1283,
                    'Indonesia': 1282,
                    'Netherlands': 990,
                    'Saudi Arabia': 833,
                    'Turkey': 819,
                    'Switzerland': 807
                };

                // Mock military strength rank
                const militaryRank = {
                    'USA': 1,
                    'Russia': 2,
                    'China': 3,
                    'India': 4,
                    'Japan': 5,
                    'South Korea': 6,
                    'France': 7,
                    'UK': 8,
                    'Pakistan': 9,
                    'Brazil': 10,
                    'Italy': 11,
                    'Turkey': 12,
                    'Egypt': 13,
                    'Iran': 14,
                    'Germany': 15,
                    'Indonesia': 16,
                    'Thailand': 17,
                    'Vietnam': 18,
                    'Poland': 19,
                    'Israel': 20
                };

                state.countries.forEach(country => {
                    // Add GDP data
                    const gdp = gdpData[country.name.common] || Math.round(Math.random() * 500 + 10);
                    country.gdp = gdp;

                    // Add military rank
                    const rank = militaryRank[country.name.common] || Math.round(Math.random() * 100 + 20);
                    country.militaryRank = rank;
                });
            }

            // Fetch real exchange rates
            async function fetchExchangeRates() {
                try {
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                    const data = await response.json();
                    state.exchangeRates = data.rates;
                } catch (error) {
                    console.error('Failed to fetch exchange rates:', error);
                    // Fallback to some mock rates if API fails
                    state.exchangeRates = {
                        'USD': 1,
                        'EUR': 0.85,
                        'GBP': 0.73,
                        'JPY': 110,
                        'AUD': 1.35,
                        'CAD': 1.26,
                        'CHF': 0.92,
                        'CNY': 6.45,
                        'SEK': 8.56,
                        'NZD': 1.42,
                        'BDT': 110
                    };
                }
            }

            // Organize countries by continent
            function organizeByContinent() {
                state.continents = {
                    'Africa': [],
                    'Antarctica': [],
                    'Asia': [],
                    'Europe': [],
                    'North America': [],
                    'Oceania': [],
                    'South America': []
                };

                state.countries.forEach(country => {
                    if (country.continents) {
                        country.continents.forEach(continent => {
                            if (state.continents[continent]) {
                                state.continents[continent].push(country);
                            }
                        });
                    }
                });

                // Sort countries alphabetically within each continent
                for (const continent in state.continents) {
                    state.continents[continent].sort((a, b) => 
                        a.name.common.localeCompare(b.name.common)
                    );
                }
            }

            // Render continent buttons
            function renderContinents() {
                elements.continentButtons.innerHTML = '';
                for (const continent in state.continents) {
                    const button = document.createElement('button');
                    button.className = 'p-3 bg-blue-50 rounded-lg hover:bg-blue-100 transition dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white';
                    button.textContent = continent;
                    button.addEventListener('click', () => showCountriesByContinent(continent));
                    elements.continentButtons.appendChild(button);
                }
            }

            // Show countries for a selected continent
            function showCountriesByContinent(continent) {
                elements.countryList.innerHTML = '';
                state.continents[continent].forEach(country => {
                    const countryElement = document.createElement('div');
                    countryElement.className = 'p-3 hover:bg-gray-100 rounded-lg cursor-pointer flex items-center dark:hover:bg-gray-700 dark:text-white';
                    countryElement.innerHTML = `
                        <span class="mr-2">${country.flag}</span>
                        ${country.name.common}
                    `;
                    countryElement.addEventListener('click', () => showCountryDetails(country));
                    elements.countryList.appendChild(countryElement);
                });
            }

            // Show details for a selected country
            function showCountryDetails(country) {
                state.currentCountry = country;
                elements.countryInfo.classList.remove('hidden');
                
                // Update basic info
                document.getElementById('countryName').textContent = country.name.common;
                document.getElementById('countryArea').textContent = country.area ? country.area.toLocaleString() : 'N/A';
                document.getElementById('countryPopulation').textContent = country.population.toLocaleString();
                document.getElementById('countryCapital').textContent = country.capital ? country.capital.join(', ') : 'N/A';
                
                // Currencies
                if (country.currencies) {
                    const currencies = Object.values(country.currencies).map(c => `${c.name} (${c.symbol || ''})`);
                    document.getElementById('countryCurrency').textContent = currencies.join(', ');
                } else {
                    document.getElementById('countryCurrency').textContent = 'N/A';
                }
                
                // Languages
                if (country.languages) {
                    document.getElementById('countryLanguages').textContent = Object.values(country.languages).join(', ');
                } else {
                    document.getElementById('countryLanguages').textContent = 'N/A';
                }
                
                // Timezone
                document.getElementById('countryTimezone').textContent = country.timezones ? country.timezones[0] : 'N/A';
                
                // GDP
                document.getElementById('countryGDP').textContent = country.gdp ? `$${country.gdp.toLocaleString()} billion` : 'N/A';
                
                // Military rank
                document.getElementById('countryArmyRank').textContent = country.militaryRank ? `#${country.militaryRank}` : 'N/A';
                
                // Flag
                document.getElementById('countryFlag').src = country.flags.png;
                document.getElementById('countryFlag').alt = `Flag of ${country.name.common}`;
                
                // Visa info (simplified)
                document.getElementById('countryVisa').textContent = 'Check with local embassy'; // In real app, you'd have a database
                
                // Update map to highlight selected country
                updateMapForCountry(country);
                
                // Load tourist places (mock data)
                loadTouristPlaces(country);
                
                // Load weather data
                if (country.capital && country.capital.length > 0) {
                    fetchWeatherData(country.capital[0]);
                }
                
                // Show comparison and currency tools
                elements.comparisonTool.classList.remove('hidden');
                elements.currencyConverter.classList.remove('hidden');
            }

            // Update map for selected country
            function updateMapForCountry(country) {
                // In a real app, you would fetch GeoJSON data for the country
                // and highlight it on the map. This is a simplified version.
                
                // Get approximate coordinates (using capital or first latlng)
                let lat = 0, lng = 0;
                if (country.latlng && country.latlng.length >= 2) {
                    [lat, lng] = country.latlng;
                } else if (country.capitalInfo && country.capitalInfo.latlng) {
                    [lat, lng] = country.capitalInfo.latlng;
                }
                
                // Zoom to country
                map.setView([lat, lng], 5);
                
                // In a real app, you would add a polygon overlay for the country
                // For now, we'll just add a marker
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
                
                if (lat !== 0 || lng !== 0) {
                    L.marker([lat, lng]).addTo(map)
                        .bindPopup(`<b>${country.name.common}</b><br>${country.capital ? 'Capital: ' + country.capital[0] : ''}`);
                }
            }

            // Load tourist places (mock data)
            function loadTouristPlaces(country) {
                const placesContainer = document.getElementById('touristPlaces');
                placesContainer.innerHTML = '';
                
                // Mock data - in a real app you'd fetch from an API
                const mockPlaces = {
                    'France': ['Eiffel Tower', 'Louvre Museum', 'Mont Saint-Michel'],
                    'Italy': ['Colosseum', 'Venice Canals', 'Leaning Tower of Pisa'],
                    'Japan': ['Mount Fuji', 'Tokyo Tower', 'Fushimi Inari Shrine'],
                    'USA': ['Statue of Liberty', 'Grand Canyon', 'Times Square'],
                    'default': ['Capital City', 'National Museum', 'Main Square']
                };
                
                const places = mockPlaces[country.name.common] || mockPlaces['default'];
                
                places.forEach(place => {
                    const placeElement = document.createElement('div');
                    placeElement.className = 'bg-blue-50 p-3 rounded-lg dark:bg-gray-700 dark:text-white';
                    placeElement.textContent = place;
                    placesContainer.appendChild(placeElement);
                });
            }

            // Fetch weather data
            function fetchWeatherData(city) {
                // In a real app, you would use a weather API like OpenWeatherMap
                // This is a mock implementation
                
                // Mock weather data
                const mockWeather = {
                    condition: 'Sunny',
                    temp: Math.round(Math.random() * 30 + 10),
                    humidity: Math.round(Math.random() * 50 + 30),
                    icon: '☀️'
                };
                
                document.getElementById('weatherCondition').textContent = mockWeather.condition;
                document.getElementById('weatherTemp').textContent = mockWeather.temp;
                document.getElementById('weatherHumidity').textContent = mockWeather.humidity;
                document.getElementById('weatherIcon').textContent = mockWeather.icon;
            }

            // Search autocomplete
            function populateSearchAutocomplete() {
                elements.searchInput.addEventListener('input', function() {
                    const query = this.value.toLowerCase();
                    if (query.length < 2) {
                        elements.autocompleteResults.classList.add('hidden');
                        return;
                    }
                    
                    const matches = state.countries.filter(country => 
                        country.name.common.toLowerCase().includes(query)
                    ).slice(0, 5);
                    
                    if (matches.length > 0) {
                        elements.autocompleteResults.innerHTML = '';
                        matches.forEach(country => {
                            const item = document.createElement('div');
                            item.className = 'p-3 hover:bg-gray-100 cursor-pointer dark:hover:bg-gray-700 dark:text-white';
                            item.innerHTML = `
                                <div class="flex items-center">
                                    <span class="mr-2">${country.flag}</span>
                                    ${country.name.common}
                                </div>
                            `;
                            item.addEventListener('click', () => {
                                showCountryDetails(country);
                                elements.autocompleteResults.classList.add('hidden');
                                elements.searchInput.value = country.name.common;
                            });
                            elements.autocompleteResults.appendChild(item);
                        });
                        elements.autocompleteResults.classList.remove('hidden');
                    } else {
                        elements.autocompleteResults.classList.add('hidden');
                    }
                });
                
                // Hide autocomplete when clicking elsewhere
                document.addEventListener('click', function(e) {
                    if (e.target !== elements.searchInput) {
                        elements.autocompleteResults.classList.add('hidden');
                    }
                });
            }

            // Dark mode toggle
            elements.darkModeToggle.addEventListener('click', function() {
                state.darkMode = !state.darkMode;
                if (state.darkMode) {
                    document.documentElement.classList.add('dark');
                    this.textContent = 'Light';
                } else {
                    document.documentElement.classList.remove('dark');
                    this.textContent = 'Dark';
                }
                
                // Save preference to localStorage
                localStorage.setItem('darkMode', state.darkMode);
            });

            // Language toggle
            elements.languageToggle.addEventListener('click', function() {
                state.language = state.language === 'en' ? 'bn' : 'en';
                
                if (state.language === 'bn') {
                    document.documentElement.classList.add('bn');
                    this.textContent = 'English';
                } else {
                    document.documentElement.classList.remove('bn');
                    this.textContent = 'বাংলা';
                }
                
                applyTranslations(state.language);
                localStorage.setItem('language', state.language);
            });

            // Text-to-speech
            elements.speakButton.addEventListener('click', function() {
                if (!state.currentCountry) return;
                
                if (state.isSpeaking) {
                    // Stop speaking
                    window.speechSynthesis.cancel();
                    state.isSpeaking = false;
                    elements.speakIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>`;
                    return;
                }
                
                const text = `Information about ${state.currentCountry.name.common}. 
                    Capital: ${state.currentCountry.capital ? state.currentCountry.capital[0] : 'unknown'}. 
                    Population: ${state.currentCountry.population.toLocaleString()}. 
                    Area: ${state.currentCountry.area ? state.currentCountry.area.toLocaleString() : 'unknown'} square kilometers.`;
                
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.onend = function() {
                        state.isSpeaking = false;
                        elements.speakIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>`;
                    };
                    window.speechSynthesis.speak(utterance);
                    state.isSpeaking = true;
                    elements.speakIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>`;
                } else {
                    alert(state.language === 'bn' ? 'আপনার ব্রাউজারে টেক্সট-টু-স্পিচ সাপোর্ট করে না' : 'Text-to-speech not supported in your browser');
                }
            });

            // Export as PDF
            elements.exportButton.addEventListener('click', function() {
                if (!state.currentCountry) {
                    alert(state.language === 'bn' ? 'প্রথমে একটি দেশ নির্বাচন করুন' : 'Please select a country first');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add country name as title
                doc.setFontSize(20);
                doc.text(`Country Information: ${state.currentCountry.name.common}`, 10, 20);
                
                // Add basic information
                doc.setFontSize(12);
                let y = 40;
                doc.text(`Capital: ${state.currentCountry.capital ? state.currentCountry.capital[0] : 'N/A'}`, 10, y);
                y += 10;
                doc.text(`Population: ${state.currentCountry.population.toLocaleString()}`, 10, y);
                y += 10;
                doc.text(`Area: ${state.currentCountry.area ? state.currentCountry.area.toLocaleString() : 'N/A'} km²`, 10, y);
                y += 10;
                doc.text(`Languages: ${state.currentCountry.languages ? Object.values(state.currentCountry.languages).join(', ') : 'N/A'}`, 10, y);
                y += 10;
                doc.text(`GDP: $${state.currentCountry.gdp ? state.currentCountry.gdp.toLocaleString() : 'N/A'} billion`, 10, y);
                y += 10;
                doc.text(`Military Rank: ${state.currentCountry.militaryRank ? '#' + state.currentCountry.militaryRank : 'N/A'}`, 10, y);
                y += 10;
                
                // Add flag (would need CORS proxy in real app)
                // doc.addImage(state.currentCountry.flags.png, 'PNG', 10, y, 50, 30);
                y += 40;
                
                // Add most visited places
                doc.text('Most Visited Places:', 10, y);
                y += 10;
                const placesContainer = document.getElementById('touristPlaces');
                const places = Array.from(placesContainer.children).map(el => el.textContent);
                places.forEach((place, i) => {
                    doc.text(`${i+1}. ${place}`, 15, y);
                    y += 7;
                });
                
                // Save the PDF
                doc.save(`${state.currentCountry.name.common}_information.pdf`);
            });

            // AI Assistant
            elements.aiButton.addEventListener('click', function() {
                elements.aiModal.classList.remove('hidden');
            });

            elements.closeAiModal.addEventListener('click', function() {
                elements.aiModal.classList.add('hidden');
            });

            elements.aiSubmit.addEventListener('click', function() {
                const query = elements.aiQuery.value.trim();
                if (!query) return;
                
                // Mock AI response - in a real app you'd call an AI API
                let response = '';
                if (query.toLowerCase().includes('population')) {
                    if (state.currentCountry) {
                        response = `The population of ${state.currentCountry.name.common} is ${state.currentCountry.population.toLocaleString()}.`;
                    } else {
                        response = 'Please select a country first to get population information.';
                    }
                } else if (query.toLowerCase().includes('capital')) {
                    if (state.currentCountry) {
                        response = `The capital of ${state.currentCountry.name.common} is ${state.currentCountry.capital ? state.currentCountry.capital[0] : 'not specified'}.`;
                    } else {
                        response = 'Please select a country first to get capital information.';
                    }
                } else {
                    response = `I'm a mock AI assistant. In a real application, I would provide intelligent answers about ${query}.`;
                }
                
                if (state.language === 'bn') {
                    response = `আমি একটি মক এআই সহকারী। একটি বাস্তব অ্যাপ্লিকেশনে, আমি ${query} সম্পর্কে বুদ্ধিমত্তাপূর্ণ উত্তর প্রদান করতাম।`;
                }
                
                const responseElement = document.createElement('p');
                responseElement.className = 'mb-2';
                responseElement.textContent = response;
                elements.aiResponse.appendChild(responseElement);
                elements.aiQuery.value = '';
                
                // Scroll to bottom
                elements.aiResponse.scrollTop = elements.aiResponse.scrollHeight;
            });

            // Populate comparison selects
            function populateComparisonSelects() {
                const select1 = document.getElementById('compareCountry1');
                const select2 = document.getElementById('compareCountry2');
                
                select1.innerHTML = '';
                select2.innerHTML = '';
                
                // Add empty option
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = state.language === 'bn' ? 'দেশ নির্বাচন করুন' : 'Select country';
                select1.appendChild(emptyOption.cloneNode(true));
                select2.appendChild(emptyOption.cloneNode(true));
                
                // Add all countries
                state.countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country.cca3;
                    option.textContent = country.name.common;
                    select1.appendChild(option.cloneNode(true));
                    select2.appendChild(option.cloneNode(true));
                });
                
                // Compare button handler
                document.getElementById('compareButton').addEventListener('click', function() {
                    const country1Code = select1.value;
                    const country2Code = select2.value;
                    
                    if (!country1Code || !country2Code) {
                        alert(state.language === 'bn' ? 'দুটি দেশ নির্বাচন করুন' : 'Please select two countries to compare');
                        return;
                    }
                    
                    const country1 = state.countries.find(c => c.cca3 === country1Code);
                    const country2 = state.countries.find(c => c.cca3 === country2Code);
                    
                    if (country1 && country2) {
                        showComparisonResults(country1, country2);
                    }
                });
            }

            // Show comparison results
            function showComparisonResults(country1, country2) {
                const resultsDiv = document.getElementById('comparisonResults');
                resultsDiv.innerHTML = '';
                resultsDiv.classList.remove('hidden');
                
                // Create comparison table
                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200 dark:divide-gray-700';
                
                // Table header
                const thead = document.createElement('thead');
                thead.className = 'bg-gray-50 dark:bg-gray-700';
                thead.innerHTML = `
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">${state.language === 'bn' ? 'মেট্রিক' : 'Metric'}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">${country1.name.common}</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">${country2.name.common}</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                // Table body
                const tbody = document.createElement('tbody');
                tbody.className = 'bg-white divide-y divide-gray-200 dark:divide-gray-700 dark:bg-gray-800';
                
                // Add comparison rows
                addComparisonRow(tbody, state.language === 'bn' ? 'জনসংখ্যা' : 'Population', country1.population, country2.population);
                addComparisonRow(tbody, state.language === 'bn' ? 'আয়তন (কিমি²)' : 'Area (km²)', country1.area, country2.area);
                addComparisonRow(tbody, state.language === 'bn' ? 'রাজধানী' : 'Capital', country1.capital ? country1.capital[0] : 'N/A', country2.capital ? country2.capital[0] : 'N/A');
                addComparisonRow(tbody, state.language === 'bn' ? 'জিডিপি (বিলিয়ন $)' : 'GDP (billion $)', country1.gdp, country2.gdp);
                addComparisonRow(tbody, state.language === 'bn' ? 'সামরিক শক্তি র‍্যাঙ্ক' : 'Military Strength Rank', country1.militaryRank, country2.militaryRank);
                
                table.appendChild(tbody);
                resultsDiv.appendChild(table);
            }

            // Add a row to comparison table
            function addComparisonRow(tbody, metric, value1, value2) {
                const row = document.createElement('tr');
                row.className = 'dark:bg-gray-800';
                
                // Format values
                let display1 = value1;
                let display2 = value2;
                
                if (typeof value1 === 'number') {
                    display1 = value1.toLocaleString();
                    display2 = value2.toLocaleString();
                    
                    // Add comparison indicator
                    if (value1 > value2) {
                        display1 += ' ▲';
                        display2 += ' ▼';
                    } else if (value1 < value2) {
                        display1 += ' ▼';
                        display2 += ' ▲';
                    } else {
                        display1 += ' =';
                        display2 += ' =';
                    }
                }
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${metric}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${display1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${display2}</td>
                `;
                tbody.appendChild(row);
            }

            // Populate currency selects
            function populateCurrencySelects() {
                const fromSelect = document.getElementById('convertFrom');
                const toSelect = document.getElementById('convertTo');
                
                // Get unique currencies from all countries
                const currencies = new Set();
                state.countries.forEach(country => {
                    if (country.currencies) {
                        Object.keys(country.currencies).forEach(code => {
                            currencies.add(`${code} - ${country.currencies[code].name}`);
                        });
                    }
                });
                
                // Add to selects
                fromSelect.innerHTML = '';
                toSelect.innerHTML = '';
                
                // Add empty option
                const emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = state.language === 'bn' ? 'মুদ্রা নির্বাচন করুন' : 'Select currency';
                fromSelect.appendChild(emptyOption.cloneNode(true));
                toSelect.appendChild(emptyOption.cloneNode(true));
                
                // Add currencies
                currencies.forEach(currency => {
                    const option = document.createElement('option');
                    option.value = currency.split(' - ')[0]; // Use currency code
                    option.textContent = currency;
                    fromSelect.appendChild(option.cloneNode(true));
                    toSelect.appendChild(option.cloneNode(true));
                });
                
                // Set default to USD and BDT
                Array.from(fromSelect.options).forEach(opt => {
                    if (opt.value === 'USD') opt.selected = true;
                });
                Array.from(toSelect.options).forEach(opt => {
                    if (opt.value === 'BDT') opt.selected = true;
                });
                
                // Convert button handler
                document.getElementById('convertButton').addEventListener('click', async function() {
                    const amount = parseFloat(document.getElementById('convertAmount').value);
                    const fromCurrency = fromSelect.value;
                    const toCurrency = toSelect.value;
                    
                    if (!amount || !fromCurrency || !toCurrency) {
                        alert(state.language === 'bn' ? 'সমস্ত ফিল্ড পূরণ করুন' : 'Please fill all fields');
                        return;
                    }
                    
                    // Try to use real exchange rates first
                    if (state.exchangeRates[fromCurrency] && state.exchangeRates[toCurrency]) {
                        const rate = state.exchangeRates[toCurrency] / state.exchangeRates[fromCurrency];
                        const result = amount * rate;
                        const resultDiv = document.getElementById('conversionResult');
                        resultDiv.innerHTML = `
                            ${amount} ${fromCurrency} = ${result.toFixed(2)} ${toCurrency}
                        `;
                        resultDiv.classList.remove('hidden');
                        return;
                    }
                    
                    // Fallback to mock rates if real rates not available
                    const mockRates = {
                        'USD': { 'BDT': 110, 'EUR': 0.85, 'JPY': 110 },
                        'EUR': { 'USD': 1.18, 'BDT': 130, 'JPY': 130 },
                        'BDT': { 'USD': 0.0091, 'EUR': 0.0077, 'JPY': 0.12 },
                        'JPY': { 'USD': 0.0091, 'EUR': 0.0077, 'BDT': 1.2 }
                    };
                    
                    let rate = 1;
                    if (mockRates[fromCurrency] && mockRates[fromCurrency][toCurrency]) {
                        rate = mockRates[fromCurrency][toCurrency];
                    } else if (mockRates[toCurrency] && mockRates[toCurrency][fromCurrency]) {
                        rate = 1 / mockRates[toCurrency][fromCurrency];
                    } else {
                        rate = Math.random() * 10; // Fallback random rate
                    }
                    
                    const result = amount * rate;
                    const resultDiv = document.getElementById('conversionResult');
                    resultDiv.innerHTML = `
                        ${amount} ${fromCurrency} = ${result.toFixed(2)} ${toCurrency}
                    `;
                    resultDiv.classList.remove('hidden');
                });
            }

            // Initialize from localStorage
            if (localStorage.getItem('darkMode') === 'true') {
                state.darkMode = true;
                document.documentElement.classList.add('dark');
                elements.darkModeToggle.textContent = 'Light';
            }
            
            if (localStorage.getItem('language') === 'bn') {
                state.language = 'bn';
                document.documentElement.classList.add('bn');
                elements.languageToggle.textContent = 'English';
                applyTranslations('bn');
            }
        });
    </script>
</body>
</html>
